-- @testpoint: interval分区,EXCHANGE PARTITION普通表中的数据满足指定分区的分区键范围，指定WITHOUT VALIDATION
drop table if exists tb_c;
SQL SUCCESS
drop table if exists tb_p;
SQL SUCCESS
drop tablespace if exists tsp_1;
SQL SUCCESS
drop tablespace if exists tsp_2;
SQL SUCCESS
create tablespace tsp_1 relative location 'partition_table_space/tsp_1' maxsize '10m';
SQL SUCCESS
create tablespace tsp_2 relative location 'partition_table_space/tsp_2' maxsize '10m';
SQL SUCCESS
create table tb_p(c1 smallint,c2 char(30),c3 int,
c4 date not null,c5 boolean,c6 nchar(30),c7 float)
partition by range (c4)interval ('1 month')
(partition tb_p_p1 values less than ('2020-01-01') tablespace tsp_1);
SQL SUCCESS
create table tb_c(c1 smallint,c2 char(30),
c3 int,c4 date not null,c5 boolean,c6 nchar(30),
c7 float)tablespace tsp_2;
SQL SUCCESS
-- tb_p插入数据
insert into tb_p values (1,'aaa',1,'2019-12-31',true,'aaa',1.1);
SQL SUCCESS
insert into tb_p values (2,'bbb',2,'2020-01-01',false,'bbb',2.2);
SQL SUCCESS
insert into tb_p values (3,'ccc',3,'2020-02-01',true,'ccc',3.3);
SQL SUCCESS
-- tb_c插入数据
insert into tb_c values (2,'ggg',2,'2020-01-01',false,'ggg',2.2);
SQL SUCCESS
select relname, boundaries, spcname from pg_partition p join pg_tablespace t on p.reltablespace=t.oid
where p.parentid = (select oid from pg_class where relname = 'tb_p') order by relname;
+---------+--------------+---------+
| relname | boundaries   | spcname |
+---------+--------------+---------+
| tb_p_p1 | {2020-01-01} | tsp_1   |
+---------+--------------+---------+
-- 查看各分区中数据
select * from tb_p partition (tb_p_p1)order by c4;
+----+--------------------------------+----+-------------------------------+------+--------------------------------+-----+
| c1 | c2                             | c3 | c4                            | c5   | c6                             | c7  |
+----+--------------------------------+----+-------------------------------+------+--------------------------------+-----+
| 1  | aaa                            | 1  | 2019-12-31 00:00:00.000000000 | true | aaa                            | 1.1 |
+----+--------------------------------+----+-------------------------------+------+--------------------------------+-----+
select * from tb_p partition (sys_p1)order by c4;
+----+--------------------------------+----+-------------------------------+-------+--------------------------------+-----+
| c1 | c2                             | c3 | c4                            | c5    | c6                             | c7  |
+----+--------------------------------+----+-------------------------------+-------+--------------------------------+-----+
| 2  | bbb                            | 2  | 2020-01-01 00:00:00.000000000 | false | bbb                            | 2.2 |
+----+--------------------------------+----+-------------------------------+-------+--------------------------------+-----+
select * from tb_p partition (sys_p2)order by c4;
+----+--------------------------------+----+-------------------------------+------+--------------------------------+-----+
| c1 | c2                             | c3 | c4                            | c5   | c6                             | c7  |
+----+--------------------------------+----+-------------------------------+------+--------------------------------+-----+
| 3  | ccc                            | 3  | 2020-02-01 00:00:00.000000000 | true | ccc                            | 3.3 |
+----+--------------------------------+----+-------------------------------+------+--------------------------------+-----+
select * from tb_c;
+----+--------------------------------+----+-------------------------------+-------+--------------------------------+-----+
| c1 | c2                             | c3 | c4                            | c5    | c6                             | c7  |
+----+--------------------------------+----+-------------------------------+-------+--------------------------------+-----+
| 2  | ggg                            | 2  | 2020-01-01 00:00:00.000000000 | false | ggg                            | 2.2 |
+----+--------------------------------+----+-------------------------------+-------+--------------------------------+-----+
alter table tb_p exchange partition (sys_p1) with table tb_c without validation;
SQL SUCCESS
select * from tb_p partition (tb_p_p1)order by c4;
+----+--------------------------------+----+-------------------------------+------+--------------------------------+-----+
| c1 | c2                             | c3 | c4                            | c5   | c6                             | c7  |
+----+--------------------------------+----+-------------------------------+------+--------------------------------+-----+
| 1  | aaa                            | 1  | 2019-12-31 00:00:00.000000000 | true | aaa                            | 1.1 |
+----+--------------------------------+----+-------------------------------+------+--------------------------------+-----+
select * from tb_p partition (sys_p1)order by c4;
+----+--------------------------------+----+-------------------------------+-------+--------------------------------+-----+
| c1 | c2                             | c3 | c4                            | c5    | c6                             | c7  |
+----+--------------------------------+----+-------------------------------+-------+--------------------------------+-----+
| 2  | ggg                            | 2  | 2020-01-01 00:00:00.000000000 | false | ggg                            | 2.2 |
+----+--------------------------------+----+-------------------------------+-------+--------------------------------+-----+
select * from tb_p partition (sys_p2)order by c4;
+----+--------------------------------+----+-------------------------------+------+--------------------------------+-----+
| c1 | c2                             | c3 | c4                            | c5   | c6                             | c7  |
+----+--------------------------------+----+-------------------------------+------+--------------------------------+-----+
| 3  | ccc                            | 3  | 2020-02-01 00:00:00.000000000 | true | ccc                            | 3.3 |
+----+--------------------------------+----+-------------------------------+------+--------------------------------+-----+
select * from tb_c;
+----+--------------------------------+----+-------------------------------+-------+--------------------------------+-----+
| c1 | c2                             | c3 | c4                            | c5    | c6                             | c7  |
+----+--------------------------------+----+-------------------------------+-------+--------------------------------+-----+
| 2  | bbb                            | 2  | 2020-01-01 00:00:00.000000000 | false | bbb                            | 2.2 |
+----+--------------------------------+----+-------------------------------+-------+--------------------------------+-----+
select relname, boundaries, spcname from pg_partition p join pg_tablespace t on p.reltablespace=t.oid
where p.parentid = (select oid from pg_class where relname = 'tb_p') order by relname;
+---------+-----------------------+---------+
| relname | boundaries            | spcname |
+---------+-----------------------+---------+
| sys_p1  | {2020-02-01 00:00:00} | tsp_2   |
| tb_p_p1 | {2020-01-01}          | tsp_1   |
+---------+-----------------------+---------+
drop table if exists tb_p;
SQL SUCCESS
drop table if exists tb_c;
SQL SUCCESS
drop tablespace if exists tsp_1;
SQL SUCCESS
drop tablespace if exists tsp_2;
SQL SUCCESS
